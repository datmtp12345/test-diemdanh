const defaultMembers = [{
    id: "HE204906",
    name: "Tr·∫ßn Tu·∫•n Anh",
    team: 4,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HS200273",
    name: "Nguy·ªÖn ƒê·ª©c Anh",
    team: 4,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HE201437",
    name: "L√™ Qu·ªëc ƒê·∫°t",
    team: 1,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HE205151",
    name: "Tr·∫ßn Kh·∫Øc ƒê·∫°t",
    team: 3,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HS204475",
    name: "L√™ ƒê·∫Øc Tu·∫•n Anh",
    team: 2,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HE204315",
    name: "Cao VƒÉn ƒê·∫°t",
    team: 3,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HE201118",
    name: "L√™ Quang ƒê·ª©c",
    team: 1,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HE201209",
    name: "Ph·∫°m ƒêan D∆∞∆°ng",
    team: 4,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HS204176",
    name: "Tr·∫ßn Th·ªã Kim Hi·ªÅn",
    team: 3,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HE204902",
    name: "B√πi Trung Hi·∫øu",
    team: 4,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HE204638",
    name: "H√† Huy Ho√†ng",
    team: 2,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HS200507",
    name: "Tr·∫ßn Th·ªã Thu H·ªìng",
    team: 4,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HE204019",
    name: "Nguy·ªÖn Ph√∫ Ho√†ng",
    team: 2,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HS204445",
    name: "Ph·∫°m Th·ªã H∆∞∆°ng",
    team: 2,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HS204216",
    name: "ƒê·ªó Minh Khi√™m",
    team: 1,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HS200347",
    name: "ƒê·ªó Th·ªã Thu·ª≥ Linh",
    team: 2,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HE201320",
    name: "Nguy·ªÖn Ph∆∞·ªõc L·ªôc",
    team: 4,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HA204002",
    name: "Phan V≈© ƒê·ª©c L∆∞∆°ng",
    team: 4,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HS200817",
    name: "Nguy·ªÖn Th·ªã Xu√¢n Mai",
    team: 1,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HE201302",
    name: "ƒê√†o B√πi B·∫£o Ng·ªçc",
    team: 2,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HE201048",
    name: "B√πi Xu√¢n Quang",
    team: 1,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HE201896",
    name: "Nguy·ªÖn Ho√†ng T√∫ Nhi",
    team: 3,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HE201295",
    name: "Nguy·ªÖn ƒê·ª©c Quang",
    team: 2,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HS204031",
    name: "B√πi Th·∫£o Quy√™n",
    team: 3,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HS204246",
    name: "Phan H·ªìng Quy√™n",
    team: 3,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HS200200",
    name: "ƒê·∫∑ng K·ª≥ Th∆∞",
    team: 1,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HE204651",
    name: "L√™ C√¥ng Tuy·ªÉn",
    team: 3,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HS200854",
    name: "Nguy·ªÖn Ng·ªçc Ly V√¢n",
    team: 3,
    status: "Kh√¥ng c√≥ m·∫∑t"
  },
  {
    id: "HE200074",
    name: "Nguy·ªÖn ƒê·ª©c Minh",
    team: 1,
    status: "Kh√¥ng c√≥ m·∫∑t"
  }
];

let members = [];
let isAdmin = false;
let attendanceHistory = JSON.parse(localStorage.getItem("attendanceHistory")) || [];

function getCurrentDate() {
  return new Date().toISOString().slice(0, 10);
}

function loadMembers() {
  return db
    .ref("members")
    .once("value")
    .then((snap) => {
      const stored = snap.exists() ? snap.val() : null;
      return stored || defaultMembers;
    });
}

function renderMembers() {
  const memberList = document.getElementById("member-list");
  const stats = document.getElementById("member-stats");
  if (!members) return;

  memberList.innerHTML = "";

  const sortedMembers = members.slice().sort((a, b) => a.team - b.team);
  let presentCount = 0;
  sortedMembers.forEach(member => {
    if (member.status === "C√≥ m·∫∑t") presentCount++;
    let statusClass = "absent";
    if (member.status === "C√≥ m·∫∑t") statusClass = "present";
    else if (member.status === "ƒêi mu·ªôn") statusClass = "late";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${member.id}</td>
      <td>${member.name}</td>
      <td>${member.team}</td>
      <td>
        <button id="btn-${member.id}"
                class="button ${statusClass}"
                onclick="toggleAttendance('${member.id}')">
          ${member.status}
        </button>
      </td>
      <td>
        ${isAdmin ? `<button class="button remove" onclick="removeMember('${member.id}')">X√≥a</button>` : ""}
      </td>
    `;
    memberList.appendChild(row);
  });

  stats.textContent = `T·ªïng th√†nh vi√™n: ${members.length} | ƒê√£ ƒëi·ªÉm danh: ${presentCount}`;
}

window.toggleAttendance = function (id) {
  const member = members.find(m => m.id === id);
  if (!member) return;

  if (!isAdmin) {
    if (attendanceHistory.some(entry => entry.id === id && entry.date === getCurrentDate())) {
      alert("B·∫°n ƒë√£ ƒëi·ªÉm danh r·ªìi!");
      return;
    }
    member.status = "C√≥ m·∫∑t";
    attendanceHistory.push({ id: member.id, name: member.name, date: getCurrentDate(), status: "C√≥ m·∫∑t" });
  } else {
    const currentStatus = member.status;
    const nextStatus = currentStatus === "Kh√¥ng c√≥ m·∫∑t" ? "C√≥ m·∫∑t"
                      : currentStatus === "C√≥ m·∫∑t" ? "ƒêi mu·ªôn"
                      : "Kh√¥ng c√≥ m·∫∑t";
    member.status = nextStatus;
    // X√≥a b·∫£n ghi c≈© trong c√πng ng√†y
    attendanceHistory = attendanceHistory.filter(entry => !(entry.id === member.id && entry.date === getCurrentDate()));
    // Ghi b·∫£n ghi m·ªõi
    attendanceHistory.push({ id: member.id, name: member.name, date: getCurrentDate(), status: nextStatus });
  }

  localStorage.setItem("attendanceHistory", JSON.stringify(attendanceHistory));
  db.ref("members").set(members);
  renderMembers();
};

window.addMember = function () {
  const id = document.getElementById("new-id").value.trim();
  const name = document.getElementById("new-name").value.trim();
  const team = parseInt(document.getElementById("new-team").value);

  if (!id || !name || isNaN(team)) {
    alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
    return;
  }

  if (members.some(m => m.id === id)) {
    alert("M√£ s·ªë ƒë√£ t·ªìn t·∫°i!");
    return;
  }

  members.push({ id, name, team, status: "Kh√¥ng c√≥ m·∫∑t" });
  db.ref("members").set(members);
  renderMembers();
  document.getElementById("new-id").value = "";
  document.getElementById("new-name").value = "";
  document.getElementById("new-team").value = "";
};

window.removeMember = function (id) {
  if (!isAdmin) return;
  const index = members.findIndex(m => m.id === id);
  if (index !== -1) {
    members.splice(index, 1);
    db.ref("members").set(members);
    renderMembers();
  }
};

window.resetAttendance = function () {
  if (!isAdmin) return;
  members.forEach(m => m.status = "Kh√¥ng c√≥ m·∫∑t");
  attendanceHistory = [];
  localStorage.removeItem("attendanceHistory");
  db.ref("members").set(members);
  renderMembers();
};

window.adminLogin = function () {
  const email = document.getElementById("admin-email").value.trim();
  if (email === "datmtp12345@gmail.com") {
    isAdmin = true;
    document.querySelector(".admin-login").style.display = "none";
    document.getElementById("admin-controls").style.display = "block";
    renderMembers();
  } else {
    alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p!");
  }
};

window.renderHistory = function () {
  const historyContainer = document.getElementById("history-container");
  const historyList = document.getElementById("history-list");

  if (historyContainer.style.display === "none" || historyContainer.style.display === "") {
    historyContainer.style.display = "block";
    historyList.innerHTML = "";
    const grouped = {};
    attendanceHistory.forEach(entry => {
      if (!grouped[entry.date]) grouped[entry.date] = [];
      grouped[entry.date].push(entry);
    });
    Object.keys(grouped).forEach(date => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${date}</td>
        <td>${grouped[date].length}</td>
        <td><button onclick="exportHistory('${date}')">T·∫£i v·ªÅ</button></td>
      `;
      historyList.appendChild(row);
    });
  } else {
    historyContainer.style.display = "none";
  }
};

window.exportHistory = function (date) {
  const filtered = attendanceHistory.filter(e => e.date === date);
  let present = 0, late = 0, absent = 0;
  const contentLines = [`L·ªãch s·ª≠ ƒëi·ªÉm danh - Ng√†y: ${date}`, "STT, ID, H·ªç t√™n, Tr·∫°ng th√°i"];
  const latestStatusMap = {};

  // Ch·ªâ l·∫•y b·∫£n ghi cu·ªëi c√πng trong ng√†y c·ªßa m·ªói ID
  filtered.forEach(e => latestStatusMap[e.id] = e);

  const latestEntries = Object.values(latestStatusMap);
  latestEntries.forEach((e, idx) => {
    contentLines.push(`${idx + 1}, ${e.id}, ${e.name}, ${e.status}`);
    if (e.status === "C√≥ m·∫∑t") present++;
    else if (e.status === "ƒêi mu·ªôn") late++;
  });
  absent = members.length - present - late;
  contentLines.push("");
  contentLines.push(`T·ªïng s·ªë: ${members.length}`);
  contentLines.push(`C√≥ m·∫∑t: ${present}`);
  contentLines.push(`ƒêi mu·ªôn: ${late}`);
  contentLines.push(`V·∫Øng m·∫∑t: ${absent}`);
  const blob = new Blob([contentLines.join("\n")], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `diem_danh_${date}.txt`;
  a.click();
};

loadMembers().then((loadedMembers) => {
  members = loadedMembers;
  renderMembers();
  if (!Array.isArray(members) || members === defaultMembers) {
    db.ref("members").set(defaultMembers);
  }
});

db.ref("members").on("value", snapshot => {
  const data = snapshot.val();
  if (data) {
    members = data;
    renderMembers();
  }
});


//√¢ura√¢ura
const musicList = [
  "musics/b√† s√°u b√°n x√¥i.mp3",
  "musics/m√† t√† cu.mp3",
  "musics/ui ia.mp3"
];

function getRandomMusic() {
  const index = Math.floor(Math.random() * musicList.length);
  return musicList[index];
}

function checkPassword() {
  const input = document.getElementById("passwordInput").value;
  if (input === "anhdatdepzai") {
    document.getElementById("authSection").style.display = "none";
    const button = document.getElementById("musicButton");
    button.style.display = "inline-block";
    button.classList.add("show");

    const music = document.getElementById("musicPlayer");
    music.src = getRandomMusic();
  } else {
    alert("Sai m√£! Th·ª≠ l·∫°i.");
  }
}

let flashIntervalId = null;
const body = document.body;
const images = [
  "pictures/do1.jpg",
  "pictures/do2.jpg",
  "pictures/do3.jpg",
  "pictures/do4.jpg",
  "pictures/do5.jpg",
  "pictures/do6.jpg",
  "pictures/do7.jpg"
];
let imgIndex = 0;

function flashBackground() {
  // B·∫≠t hi·ªáu ·ª©ng rung + nh√°y s√°ng
  body.style.animation = "shake 0.25s infinite, flashBrightness 0.5s infinite";

  flashIntervalId = setInterval(() => {
    body.style.backgroundImage = `url(${images[imgIndex]})`;
    imgIndex = (imgIndex + 1) % images.length;
  }, 500);
}

function stopFlashBackground() {
  if (flashIntervalId) {
    clearInterval(flashIntervalId);
    flashIntervalId = null;
  }
  body.style.animation = ""; // T·∫Øt hi·ªáu ·ª©ng
}

function resetBackground() {
  body.style.backgroundImage = "url('pictures/Doraemon2.jpg')";
}

function toggleMusic() {
  const music = document.getElementById("musicPlayer");
  if (music.paused) {
    music.play();
    flashBackground();
  } else {
    music.pause();
    music.currentTime = 0;
    stopFlashBackground();
    resetBackground();
  }
}
// k·∫øt auraaura


//text h2 chay
const texts = [
  "Top 1 Luk Doraemon üòé",
  "Winning an debate is easy ü•≤",
  "Tho√°t Luk üòè ",
  "ƒê·∫°t ƒê·∫πp Trai L√† Th·∫≠t üòò",
  "B·∫°n s·ª£ MB üò•",
  "C∆∞·ªùi nhi·ªÅu v√†o ü§£"
];

function changeText() {
  const h2 = document.getElementById('randomText');
  let newText;
  do {
    newText = texts[Math.floor(Math.random() * texts.length)];
  } while (newText === h2.textContent); // tr√°nh tr√πng vƒÉn b·∫£n
  h2.style.opacity = 0;
  setTimeout(() => {
    h2.textContent = newText;
    h2.style.opacity = 1;
  }, 300);
}

// T·ª± ƒë·ªông ƒë·ªïi m·ªói 5 gi√¢y
setInterval(changeText, 5000);



// m·ªõim·ªõi